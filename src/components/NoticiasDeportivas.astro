---
import "../styles/global.css";
import { fetchFromAPI, STRAPI_BASE_URL } from "../lib/strapi";

interface ImagenFormat {
  url: string;
}

interface ImagenData {
  url: string;
  formats?: {
    large?: ImagenFormat;
    medium?: ImagenFormat;
    small?: ImagenFormat;
    thumbnail?: ImagenFormat;
  };
}

interface Noticia {
  documentId: string;
  titulo: string;
  descripcion: string;
  fecha: string;
  autor: string;
  imagen: ImagenData[]; // Es un Array
}

const response = await fetchFromAPI("noticiadeportivas");
const noticias: Noticia[] = response || [];

const getImageUrl = (imagenes: Noticia["imagen"]) => {
  if (!imagenes || !Array.isArray(imagenes) || imagenes.length === 0) {
    return null;
  }

  const imagenPrincipal = imagenes[0];

  const url =
    imagenPrincipal.formats?.large?.url ||
    imagenPrincipal.formats?.medium?.url ||
    imagenPrincipal.formats?.small?.url ||
    imagenPrincipal.url;

  if (!url) return null;

  if (url.startsWith("http")) return url;
  return `${STRAPI_BASE_URL}${url}`;
};
---

<div class="bg-gray-100">
  <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
    <div class="mb-8">
      <h2 class="text-2xl font-bold text-gray-900">Noticias Deportivas</h2>
      <div class="relative mt-2 h-0.5 bg-gray-200">
        <div class="absolute top-0 left-0 h-0.5 w-10 bg-red-600"></div>
      </div>
    </div>

    {
      noticias.length > 0 ? (
        <>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-10">
            {noticias.slice(0, 4).map((noticia, index) => {
              const imgUrl = getImageUrl(noticia.imagen);

              return (
                <a
                  href={`/noticiadeportiva/${noticia.documentId}`}
                  class={`col-span-1 ${
                    index === 0
                      ? "md:col-span-2 row-span-1 md:row-span-2 h-96"
                      : index === 1
                        ? "md:col-span-2 h-48 md:h-auto"
                        : "md:col-span-1 h-48"
                  } flex items-end p-4 relative overflow-hidden group`}
                >
                  {imgUrl && (
                    <img
                      src={imgUrl}
                      alt={noticia.titulo}
                      class="absolute inset-0 w-full h-full object-cover"
                    />
                  )}
                  <div class="text-white relative z-10 bg-black/30 p-4 rounded">
                    <h2
                      class={`${index === 0 ? "text-2xl" : "text-lg"} font-bold`}
                    >
                      {noticia.titulo}
                    </h2>
                    <p class="text-xs mt-1">
                      Por {noticia.autor} | {noticia.fecha}
                    </p>
                  </div>
                </a>
              );
            })}
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
            {noticias.slice(4, 8).map((noticia) => {
              const imgUrl = getImageUrl(noticia.imagen);

              return (
                <a
                  href={`/noticiadeportiva/${noticia.documentId}`}
                  class="bg-white p-2 shadow-sm hover:shadow-md transition duration-300 block"
                >
                  <div class="h-32 bg-gray-200 mb-2 overflow-hidden">
                    {imgUrl && (
                      <img
                        src={imgUrl}
                        alt={noticia.titulo}
                        class="w-full h-full object-cover"
                      />
                    )}
                  </div>
                  <p class="text-xs text-gray-600">
                    Por {noticia.autor} | {noticia.fecha}
                  </p>
                  <h3 class="text-base font-semibold mt-1">{noticia.titulo}</h3>
                </a>
              );
            })}
          </div>
        </>
      ) : (
        <div class="text-center py-10 text-gray-500">
          <p>No se encontraron noticias deportivas.</p>
        </div>
      )
    }
  </div>
</div>
